# アーキテクチャ

state_gate のアーキテクチャは、3つの主要コンポーネントで構成される。

## コンポーネント概要

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         Integration Layer                                │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────┐  │
│  │   MCP Server    │  │  Hook Adapter   │  │         CLI             │  │
│  │   (対話面)       │  │   (実行面)       │  │      (汎用連携)          │  │
│  └────────┬────────┘  └────────┬────────┘  └───────────┬─────────────┘  │
└───────────┼────────────────────┼──────────────────────┼─────────────────┘
            │                    │                      │
            └────────────────────┼──────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           State Engine                                   │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │  Process 定義読込 → イベント受理 → ガード評価 → 遷移実行 → 派生計算  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────────────────┘
                                  │
                     ┌────────────┴────────────┐
                     ▼                         ▼
           ┌───────────────────┐     ┌───────────────────┐
           │   Artifact Store  │     │   Run Management  │
           │    (成果物参照)    │     │   (CSV追記方式)    │
           └───────────────────┘     └───────────────────┘
```

---

## 1. State Engine

**役割**: Process 定義を読み込み、イベント受理、ガード評価、遷移、派生情報の計算を行う中核コンポーネント。

### 責務

- Process 定義のパースと検証
- 現在状態の管理
- イベントの受理判定
- ガード条件の評価
- 状態遷移の実行
- 次に必要な成果物・アクションの計算

### 処理フロー

```
イベント受信
    │
    ▼
┌─────────────────┐
│ revision チェック │ ─── 不一致 ──▶ 拒否 (CONFLICT)
└────────┬────────┘
         │ 一致
         ▼
┌─────────────────┐
│ 権限チェック      │ ─── 不許可 ──▶ 拒否 (FORBIDDEN)
└────────┬────────┘
         │ 許可
         ▼
┌─────────────────┐
│ ガード評価       │ ─── 未充足 ──▶ 拒否 (GUARD_FAILED)
└────────┬────────┘
         │ 充足
         ▼
┌─────────────────┐
│ 状態遷移実行      │
│ revision 更新    │
│ (CSV追記)        │
└────────┬────────┘
         │
         ▼
    成功レスポンス
```

---

## 2. Artifact Store

**役割**: 成果物への参照（ファイルパス）を管理する。

### バックエンド

- **ローカルファイルシステム**: ファイルパスで参照

### 成果物の参照方式

CSV の `artifact_paths` 列にセミコロン区切りでファイルパスを保存。
ガード条件としてファイルの存在を確認する。

```
artifact_paths 例: ./evidence/obs1.md;./evidence/obs2.md
```

---

## 3. Integration Layer

### 3.1 MCP Server（対話面）

エージェントが状態を問い合わせ、イベントを発行するための標準インターフェース。

詳細: [MCP インターフェース](mcp-interface.md)

### 3.2 Hook Adapter（実行面）

Claude Code hooks から state_gate を呼び出し、ツール実行の許可/拒否を行う。

詳細: [Hook Adapter](hook-adapter.md)

### 3.3 CLI（汎用連携）

Hook やスクリプトからの連携用。

```
MCP: 対話面（エージェントとの双方向通信）
CLI: 実行面（スクリプト・自動化との連携）
```

---

## データフロー

### 典型的なフロー: エージェントによる証拠提出

```
┌──────────┐         ┌──────────┐         ┌──────────┐
│  Agent   │         │   MCP    │         │  State   │
│          │         │  Server  │         │  Engine  │
└────┬─────┘         └────┬─────┘         └────┬─────┘
     │                    │                    │
     │  get_state         │                    │
     │───────────────────▶│                    │
     │                    │  query current     │
     │                    │───────────────────▶│
     │                    │  state + context   │
     │                    │◀───────────────────│
     │  response          │                    │
     │◀───────────────────│                    │
     │                    │                    │
     │  (作業実行)         │                    │
     │                    │                    │
     │  emit_event        │                    │
     │  (submit_evidence) │                    │
     │───────────────────▶│                    │
     │                    │  process event     │
     │                    │───────────────────▶│
     │                    │                    │  ┌─────────────┐
     │                    │                    │──│ Run CSV     │
     │                    │                    │  │ (追記)       │
     │                    │                    │◀─└─────────────┘
     │                    │  result            │
     │                    │◀───────────────────│
     │  response          │                    │
     │◀───────────────────│                    │
     │                    │                    │
```

### Hook Adapter 経由のフロー（PreToolUse）

```
┌──────────┐  ┌──────────┐  ┌──────────┐
│ Claude   │  │  Hook    │  │  State   │
│  Code    │  │ Adapter  │  │  Gate    │
└────┬─────┘  └────┬─────┘  └────┬─────┘
     │             │             │
     │ PreToolUse  │             │
     │────────────▶│             │
     │             │ get_state   │
     │             │────────────▶│
     │             │ state       │
     │             │◀────────────│
     │             │ policy eval │
     │ allow/deny  │             │
     │◀────────────│             │
     │             │             │
     │ (ツール実行) │             │
```

